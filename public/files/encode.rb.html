<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>/var/www/code/encode.rb.html</title>
<meta name="Generator" content="Vim/7.1" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
<style type="text/css">
<!--
.Type { color: #0000ff; }
.Statement { color: #a52a2a; }
.Identifier { color: #0000ff; }
.Special { color: #ff00ff; }
.Constant { color: #ff00ff; }
pre { font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
.PreProc { color: #a020f0; }
.Comment { color: #ff0000; }
-->
</style>
</head>
<body>
<pre>
<span class="PreProc">#!/usr/bin/env ruby</span>

<span class="Comment"># == Synopsis</span>
<span class="Comment"># encode : encodes a stream to video</span>
<span class="Comment">#</span>
<span class="Comment"># == Usage</span>
<span class="Comment">#</span>
<span class="Comment"># encode [OPTION] ...</span>
<span class="Comment">#</span>
<span class="Comment"># -h, --help ::</span>
<span class="Comment">#   show help</span>
<span class="Comment"># -n, --name ::</span>
<span class="Comment">#   name of output file</span>
<span class="Comment"># -d, --dev ::</span>
<span class="Comment">#   device or file on which to operate</span>
<span class="Comment"># -v, --vcodec ::</span>
<span class="Comment">#   codec to use for video encoding</span>
<span class="Comment"># -a, --acodec ::</span>
<span class="Comment">#   codec to use for audio encoding</span>
<span class="Comment"># -b, --bpp ::</span>
<span class="Comment">#   bits per pixel</span>
<span class="Comment"># -f, --fps ::</span>
<span class="Comment">#   frames per second of input</span>
<span class="Comment"># -q, --aquality ::</span>
<span class="Comment">#   quality of audio encoding</span>
<span class="Comment"># -c, --crop ::</span>
<span class="Comment">#   crop the video to given size</span>
<span class="Comment"># -e, --extraopts ::</span>
<span class="Comment">#   provide extra arguments like length of encoding(for  testing only)</span>
<span class="Comment"># -i, --input ::</span>
<span class="Comment">#   ask for confirmation at each step</span>
<span class="Comment"># -t, --test ::</span>
<span class="Comment">#   print the commands that will be run without actual encoding</span>
<span class="Comment">#</span>
<span class="Comment"># == Author</span>
<span class="Comment">#</span>
<span class="Comment"># Srikanth K. Agaram, University of California, Irvine</span>
<span class="Comment">#</span>
<span class="Comment"># == Copyright</span>
<span class="Comment"># Copyright (c) 2006 Srikanth Agaram. Licenced under the GNU GPLv2</span>

<span class="PreProc">require</span> <span class="Special">'</span><span class="Constant">getoptlong</span><span class="Special">'</span>
<span class="PreProc">require</span> <span class="Special">'</span><span class="Constant">rdoc/usage</span><span class="Special">'</span>

<span class="PreProc">class</span> <span class="Type">Encode</span>
    <span class="Statement">attr_reader</span> <span class="Constant">:dev</span>, <span class="Constant">:name</span>, <span class="Constant">:vcodec</span>, <span class="Constant">:acodec</span>, <span class="Constant">:bpp</span>, <span class="Constant">:fps</span>, <span class="Constant">:aquality</span>, <span class="Constant">:crop</span>, <span class="Constant">:input</span>, <span class="Constant">:extraopts</span>, <span class="Constant">:aids</span>, <span class="Constant">:sids</span>
    <span class="Statement">attr_writer</span> <span class="Constant">:dev</span>, <span class="Constant">:name</span>, <span class="Constant">:vcodec</span>, <span class="Constant">:acodec</span>, <span class="Constant">:bpp</span>, <span class="Constant">:fps</span>, <span class="Constant">:aquality</span>, <span class="Constant">:crop</span>, <span class="Constant">:input</span>, <span class="Constant">:extraopts</span>, <span class="Constant">:run</span>

    <span class="Type">GRAY</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;30m</span><span class="Special">&quot;</span>
    <span class="Type">LIGHT_GRAY</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[0;37m</span><span class="Special">&quot;</span>
    <span class="Type">WHITE</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;37m</span><span class="Special">&quot;</span>
    <span class="Type">NO_COLOR</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[0m</span><span class="Special">&quot;</span>
    <span class="Type">GREEN</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[01;32m</span><span class="Special">&quot;</span>
    <span class="Type">LIGHT_BLUE</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;34m</span><span class="Special">&quot;</span>
    <span class="Type">YELLOW</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;33m</span><span class="Special">&quot;</span>
    <span class="Type">LIGHT_RED</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;31m</span><span class="Special">&quot;</span>

    <span class="PreProc">def</span> <span class="Identifier">initialize</span>()
        <span class="Identifier">@run</span> = <span class="Constant">true</span>
        <span class="Identifier">@crop</span> = <span class="Constant">nil</span>
        <span class="Identifier">@scale</span> = <span class="Constant">nil</span>
        <span class="Identifier">@aquality</span>=<span class="Constant">3</span>
        <span class="Identifier">@acodec</span>=<span class="Special">'</span><span class="Constant">mp3</span><span class="Special">'</span>
        <span class="Identifier">@bpp</span> = <span class="Constant">0.23</span>
        <span class="Identifier">@vcodec</span> = <span class="Special">'</span><span class="Constant">lavc</span><span class="Special">'</span>
        <span class="Identifier">@name</span> = <span class="Special">'</span><span class="Constant">encodeOut</span><span class="Special">'</span>
        <span class="Identifier">@dev</span> = <span class="Special">'</span><span class="Constant">dvd://1</span><span class="Special">'</span>
        <span class="Identifier">@fps</span> = <span class="Constant">23.976</span>
        <span class="Identifier">@round</span> = <span class="Constant">10</span>
        <span class="Identifier">@extraopts</span> = <span class="Constant">nil</span>
        <span class="Identifier">@input</span> = <span class="Constant">false</span>
        <span class="Identifier">@sound</span> = <span class="Special">&quot;</span><span class="Constant">-oac copy</span><span class="Special">&quot;</span>
        <span class="Identifier">@height</span> = <span class="Constant">0</span>
        <span class="Identifier">@width</span> = <span class="Constant">0</span>
        <span class="Identifier">@aids</span> = <span class="Type">Array</span>.new
        <span class="Identifier">@sids</span> = <span class="Constant">0</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">execute</span>(command)
        commandline(command)
        system(command) <span class="Statement">if</span> <span class="Identifier">@run</span>
        question(<span class="Special">&quot;</span><span class="Constant">Continue? ...</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">error</span>(message)
        puts(<span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">#{</span><span class="Type">LIGHT_RED</span><span class="Special">}#{</span>message<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">commandline</span>(command)
        puts(<span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">#{</span><span class="Type">YELLOW</span><span class="Special">}#{</span>command<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">info</span>(message)
        puts(<span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">#{</span><span class="Type">GREEN</span><span class="Special">}#{</span>message<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">question</span>(message)
        <span class="Statement">if</span> <span class="Identifier">@input</span>
            puts <span class="Special">&quot;</span><span class="Special">#{</span><span class="Type">LIGHT_BLUE</span><span class="Special">}#{</span>message<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>
            <span class="Statement">if</span> <span class="Special">&quot;&quot;</span> != gets.chomp.strip
                <span class="Statement">exit</span>(<span class="Constant">0</span>)
            <span class="Statement">end</span>
        <span class="Statement">end</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">get_info</span>()
        <span class="Statement">unless</span> <span class="Type">File</span>.exist?(<span class="Special">&quot;</span><span class="Constant">settings.rb</span><span class="Special">&quot;</span>)
            line = <span class="Constant">nil</span>
            commandline(<span class="Special">&quot;</span><span class="Constant">mplayer -ss 600 -vo null -ao null -identify </span><span class="Special">&quot;</span> +
                <span class="Special">&quot;</span><span class="Constant">-frames 101 -vf cropdetect </span><span class="Special">#{</span>dev<span class="Special">}</span><span class="Special">&quot;</span>)
            <span class="Type">IO</span>.popen(<span class="Special">&quot;</span><span class="Constant">mplayer -ss 3600 -ao null -identify -frames 101</span><span class="Special">&quot;</span> +
                <span class="Special">&quot;</span><span class="Constant"> -vf cropdetect </span><span class="Special">#{</span>dev<span class="Special">}</span><span class="Special">&quot;</span>) {|<span class="Identifier">io</span>|
                line = io.read
            }

            <span class="Identifier">@crop</span> = line.scan(<span class="Special">/</span><span class="Constant">\(-vf crop=.*?\)</span><span class="Special">/</span>)
            <span class="Identifier">@crop</span> = crop[crop.length - <span class="Constant">1</span>].gsub(<span class="Special">/</span><span class="Constant">(.*\(-vf crop=)|(\).*)</span><span class="Special">/</span>, <span class="Special">''</span>).chomp
            sline = line.scan(<span class="Special">/</span><span class="Constant">[0-9x]*\d =&gt; \d[0-9x]*</span><span class="Special">/</span>)[<span class="Constant">0</span>]
            taids = line.scan(<span class="Special">/</span><span class="Constant">.*AID.*</span><span class="Special">/</span>)
            alangs = line.scan(<span class="Special">/</span><span class="Constant">.*AID.*</span><span class="Special">/</span>).each {|<span class="Identifier">s</span>| s.gsub!(<span class="Special">/</span><span class="Constant">.*=</span><span class="Special">/</span>, <span class="Special">''</span>)}.uniq
            <span class="Identifier">@sids</span> = line.scan(<span class="Special">/</span><span class="Constant">.*SID.*</span><span class="Special">/</span>).length
            alangs.each <span class="Statement">do</span> |<span class="Identifier">alang</span>|
                i = <span class="Constant">0</span>
                <span class="Statement">while</span> i &lt; taids.length &amp;&amp; !(<span class="Special">/</span><span class="Special">#{</span>alang<span class="Special">}</span><span class="Special">/</span> =~ taids[i])
                    i = i + <span class="Constant">1</span>
                <span class="Statement">end</span>
                <span class="Identifier">@aids</span>.push(taids[i].gsub(<span class="Special">/</span><span class="Constant">(ID_AID_)|(_.*)</span><span class="Special">/</span>, <span class="Special">''</span>))
            <span class="Statement">end</span>
            <span class="Identifier">@width</span> = crop.split(<span class="Special">'</span><span class="Constant">:</span><span class="Special">'</span>)[<span class="Constant">0</span>].to_i
            <span class="Identifier">@height</span> = crop.split(<span class="Special">'</span><span class="Constant">:</span><span class="Special">'</span>)[<span class="Constant">1</span>].to_i
            a = sline.gsub(<span class="Special">/</span><span class="Constant"> =&gt; </span><span class="Special">/</span>, <span class="Special">'</span><span class="Constant">x</span><span class="Special">'</span>).split(<span class="Special">'</span><span class="Constant">x</span><span class="Special">'</span>)
            h = (a[<span class="Constant">1</span>].to_f/a[<span class="Constant">0</span>].to_f)*(a[<span class="Constant">2</span>].to_f/a[<span class="Constant">3</span>].to_f)
            <span class="Statement">if</span> h &gt; <span class="Constant">1</span>
                <span class="Identifier">@height</span> = (<span class="Identifier">@height</span>/h).round
            <span class="Statement">else</span>
                <span class="Identifier">@width</span> = (<span class="Identifier">@width</span>*h).round
            <span class="Statement">end</span>
            <span class="Identifier">@scale</span>=<span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">@width</span><span class="Special">}</span><span class="Constant">:</span><span class="Special">#{</span><span class="Identifier">@height</span><span class="Special">}</span><span class="Special">&quot;</span>
            info(<span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">@scale</span><span class="Special">}</span><span class="Constant"> </span><span class="Special">#{</span><span class="Identifier">@crop</span><span class="Special">}</span><span class="Constant"> [</span><span class="Special">#{</span><span class="Identifier">@aids</span>.join(<span class="Special">'</span><span class="Constant">, </span><span class="Special">'</span>)<span class="Special">}</span><span class="Constant">] </span><span class="Special">#{</span><span class="Identifier">@sids</span><span class="Special">}</span><span class="Special">&quot;</span>)
            settings = <span class="Type">File</span>.new(<span class="Special">&quot;</span><span class="Constant">settings.rb</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">w</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Constant">class Encode</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Special">\t</span><span class="Constant">def load_info</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Special">\t\t</span><span class="Constant">@height = </span><span class="Special">#{</span><span class="Identifier">@height</span><span class="Special">}</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Special">\t\t</span><span class="Constant">@width = </span><span class="Special">#{</span><span class="Identifier">@width</span><span class="Special">}</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Special">\t\t</span><span class="Constant">@scale = \&quot;</span><span class="Special">#{</span><span class="Identifier">@scale</span><span class="Special">}</span><span class="Constant">\&quot;</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Special">\t\t</span><span class="Constant">@crop = \&quot;</span><span class="Special">#{</span><span class="Identifier">@crop</span><span class="Special">}</span><span class="Constant">\&quot;</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Special">\t\t</span><span class="Constant">@aids = [</span><span class="Special">#{</span><span class="Identifier">@aids</span>.join(<span class="Special">'</span><span class="Constant">, </span><span class="Special">'</span>)<span class="Special">}</span><span class="Constant">]</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Special">\t\t</span><span class="Constant">@sids = </span><span class="Special">#{</span><span class="Identifier">@sids</span><span class="Special">}</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Special">\t</span><span class="Constant">end</span><span class="Special">&quot;</span>)
            settings.puts(<span class="Special">&quot;</span><span class="Constant">end</span><span class="Special">&quot;</span>)
            settings.close
            question(<span class="Special">&quot;</span><span class="Constant">Continue? ...</span><span class="Special">&quot;</span>)
        <span class="Statement">else</span>
            <span class="PreProc">load</span> <span class="Special">&quot;</span><span class="Constant">settings.rb</span><span class="Special">&quot;</span>
            load_info
            info(<span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">@scale</span><span class="Special">}</span><span class="Constant"> </span><span class="Special">#{</span><span class="Identifier">@crop</span><span class="Special">}</span><span class="Constant"> [</span><span class="Special">#{</span><span class="Identifier">@aids</span>.join(<span class="Special">'</span><span class="Constant">, </span><span class="Special">'</span>)<span class="Special">}</span><span class="Constant">] </span><span class="Special">#{</span><span class="Identifier">@sids</span><span class="Special">}</span><span class="Special">&quot;</span>)
        <span class="Statement">end</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">load_vob</span>()
        <span class="Statement">unless</span> <span class="Type">File</span>.exist?(<span class="Special">&quot;</span><span class="Constant">temp.vob</span><span class="Special">&quot;</span>)
            execute(<span class="Special">&quot;</span><span class="Constant">mplayer </span><span class="Special">#{</span><span class="Identifier">@dev</span><span class="Special">}</span><span class="Constant"> -dumpstream -dumpfile temp.vob</span><span class="Special">&quot;</span>)
        <span class="Statement">end</span>
        <span class="Identifier">@dev</span> = <span class="Special">'</span><span class="Constant">temp.vob</span><span class="Special">'</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">calc_vbitrate</span>()
        <span class="Comment"># Calculate the video bitrate, round to nearest @round</span>
        <span class="Identifier">@vbitrate</span> = (<span class="Identifier">@bpp</span>*<span class="Identifier">@fps</span>*<span class="Identifier">@height</span>*<span class="Identifier">@width</span>/(<span class="Constant">1000</span>*<span class="Identifier">@round</span>)).round*<span class="Identifier">@round</span>
        info(<span class="Special">&quot;</span><span class="Constant">vbitrate = </span><span class="Special">#{</span><span class="Identifier">@vbitrate</span><span class="Special">}</span><span class="Special">&quot;</span>)
        <span class="Comment">#settings = File.new(&quot;settings.rb&quot;, &quot;a&quot;)</span>
        <span class="Comment">#settings.puts(&quot;vbitrate = #{@vbitrate}&quot;)</span>
        <span class="Comment">#settings.close</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">make_frameno</span>()
        <span class="Statement">unless</span> <span class="Type">File</span>.exist?(<span class="Special">&quot;</span><span class="Constant">frameno.avi</span><span class="Special">&quot;</span>)
            execute(<span class="Special">&quot;</span><span class="Constant">mencoder -quiet </span><span class="Special">#{</span><span class="Identifier">@dev</span><span class="Special">}</span><span class="Constant"> -ovc frameno -o frameno.avi </span><span class="Special">&quot;</span> +
                <span class="Special">&quot;</span><span class="Constant">-oac twolame -twolameopts br=32 -vf filmdint </span><span class="Special">&quot;</span> +
                <span class="Special">&quot;</span><span class="Constant">-fps 30000/1001 -ofps 24000/1001</span><span class="Special">&quot;</span>)
        <span class="Statement">end</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">make_ogg</span>(aid)
        <span class="Statement">unless</span> <span class="Type">File</span>.exist?(<span class="Special">&quot;</span><span class="Constant">audio</span><span class="Special">#{</span>aid<span class="Special">}</span><span class="Constant">.ogg</span><span class="Special">&quot;</span>)
            execute(<span class="Special">&quot;</span><span class="Constant">mkfifo apipe ; </span><span class="Special">&quot;</span> +
                    <span class="Special">&quot;</span><span class="Constant">oggenc --quiet -q</span><span class="Special">#{</span><span class="Identifier">@aquality</span><span class="Special">}</span><span class="Constant"> -oaudio</span><span class="Special">#{</span>aid<span class="Special">}</span><span class="Constant">.ogg apipe&amp; </span><span class="Special">&quot;</span> +
                    <span class="Special">&quot;</span><span class="Constant"> mplayer </span><span class="Special">#{</span><span class="Identifier">@dev</span><span class="Special">}</span><span class="Constant"> -hardframedrop -aid </span><span class="Special">#{</span>aid<span class="Special">}</span><span class="Constant"> -vc dummy</span><span class="Special">&quot;</span> +
                    <span class="Special">&quot;</span><span class="Constant"> -vo null -af volnorm -ao pcm:file=apipe ; </span><span class="Special">&quot;</span> +
                    <span class="Special">&quot;</span><span class="Constant">rm -f apipe</span><span class="Special">&quot;</span>)
        <span class="Statement">end</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">make_lavc_2pass</span>()
        <span class="Statement">unless</span> <span class="Type">File</span>.exist?(<span class="Special">&quot;</span><span class="Constant">divx2pass.log</span><span class="Special">&quot;</span>)
            execute(<span class="Special">&quot;</span><span class="Constant">mencoder </span><span class="Special">#{</span><span class="Identifier">@dev</span><span class="Special">}</span><span class="Constant"> -vf crop=</span><span class="Special">#{</span><span class="Identifier">@crop</span><span class="Special">}</span><span class="Constant">,scale=</span><span class="Special">#{</span><span class="Identifier">@scale</span><span class="Special">}</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">,harddup,filmdint -fps 30000/1001 -ofps 24000/1001 </span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">-ffourcc XVID -o /dev/null -ovc lavc -lavcopts vcodec=mpeg4:</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">vbitrate=</span><span class="Special">#{</span><span class="Identifier">@vbitrate</span><span class="Special">}</span><span class="Constant">:mbd=2:v4mv:dia=4:mpeg_quant:</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">vpass=1:turbo </span><span class="Special">#{</span><span class="Identifier">@sound</span><span class="Special">}</span><span class="Constant"> </span><span class="Special">#{</span><span class="Identifier">@extraopts</span><span class="Special">}</span><span class="Constant"> -quiet</span><span class="Special">&quot;</span>)
        <span class="Statement">end</span>
        <span class="Statement">unless</span> <span class="Type">File</span>.exist?(<span class="Special">&quot;</span><span class="Constant">video.avi</span><span class="Special">&quot;</span>)
            execute(<span class="Special">&quot;</span><span class="Constant">mencoder </span><span class="Special">#{</span><span class="Identifier">@dev</span><span class="Special">}</span><span class="Constant"> -vf crop=</span><span class="Special">#{</span><span class="Identifier">@crop</span><span class="Special">}</span><span class="Constant">,scale=</span><span class="Special">#{</span><span class="Identifier">@scale</span><span class="Special">}</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">,harddup,filmdint -fps 30000/1001 -ofps 24000/1001 </span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">-ffourcc XVID -o video.avi -ovc lavc -lavcopts vcodec=mpeg4:</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">vbitrate=</span><span class="Special">#{</span><span class="Identifier">@vbitrate</span><span class="Special">}</span><span class="Constant">:mbd=2:v4mv:dia=4:mpeg_quant:</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">vpass=2 </span><span class="Special">#{</span><span class="Identifier">@sound</span><span class="Special">}</span><span class="Constant"> </span><span class="Special">#{</span><span class="Identifier">@extraopts</span><span class="Special">}</span><span class="Constant"> -quiet</span><span class="Special">&quot;</span>)
        <span class="Statement">end</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">make_xvid_2pass</span>()
        execute(<span class="Special">&quot;</span><span class="Constant">mencoder </span><span class="Special">#{</span>dev<span class="Special">}</span><span class="Constant"> -vf </span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">crop=</span><span class="Special">#{</span>crop<span class="Special">}</span><span class="Constant">,scale=</span><span class="Special">#{</span>scale<span class="Special">}</span><span class="Constant">,harddup -ffourcc XVID</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant"> -o /dev/null -ovc xvidenc -xvidencopts pass=1:bitrate=</span><span class="Special">#{</span>vbitrate<span class="Special">}</span><span class="Constant">:</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">me_quality=6:quant_type=mpeg -nosound -fps 24000/1001</span><span class="Special">&quot;</span>)
        execute(<span class="Special">&quot;</span><span class="Constant">mencoder </span><span class="Special">#{</span>dev<span class="Special">}</span><span class="Constant">  -vf </span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">crop=</span><span class="Special">#{</span>crop<span class="Special">}</span><span class="Constant">,scale=</span><span class="Special">#{</span>scale<span class="Special">}</span><span class="Constant">,harddup -ffourcc XVID</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant"> -o video.avi -ovc xvidenc -xvidencopts pass=2:bitrate=</span><span class="Special">#{</span>vbitrate<span class="Special">}</span><span class="Constant">:</span><span class="Special">&quot;</span> +
            <span class="Special">&quot;</span><span class="Constant">me_quality=6:quant_type=mpeg -nosound -fps 24000/1001</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">make_ogm</span>()
        info(<span class="Special">&quot;</span><span class="Constant">creating ogm: syncing audio and video</span><span class="Special">&quot;</span>)
        line = <span class="Special">&quot;&quot;</span>
        <span class="Type">IO</span>.popen(<span class="Special">&quot;</span><span class="Constant">mencoder video.avi -ovc copy -oac copy -o /dev/null</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">io</span>|
            line = io.read
        <span class="Statement">end</span>
        list = line.scan(<span class="Special">/</span><span class="Constant">.*Video stream.*</span><span class="Special">/</span>)
        vidlength = (list[list.length - <span class="Constant">1</span>].gsub(<span class="Special">/</span><span class="Constant"> secs.*</span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>).gsub(<span class="Special">/</span><span class="Constant">.* </span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>).to_f*<span class="Constant">1000</span>).to_i

        line = <span class="Special">&quot;&quot;</span>
        <span class="Type">IO</span>.popen(<span class="Special">&quot;</span><span class="Constant">ogginfo audio*.ogg</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">io</span>|
            line = io.read
        <span class="Statement">end</span>
        list = line.scan(<span class="Special">/</span><span class="Constant">.*Playback length.*</span><span class="Special">/</span>)
        min = list[list.length - <span class="Constant">1</span>].gsub(<span class="Special">/</span><span class="Constant">.* </span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>).gsub(<span class="Special">/</span><span class="Constant">m.*</span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>).to_i
        sec = list[list.length - <span class="Constant">1</span>].gsub(<span class="Special">/</span><span class="Constant">.*m:</span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>).gsub(<span class="Special">/</span><span class="Constant">s</span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>).to_i
        audlength = ((min*<span class="Constant">60</span> + sec)*<span class="Constant">1000</span>).to_i
        <span class="Comment">#execute(&quot;ogmmerge -o #{@name}.ogm -A video.avi -s 0,#{vidlength}/#{audlength} audio*.ogg&quot;)</span>
        execute(<span class="Special">&quot;</span><span class="Constant">ogmmerge -o </span><span class="Special">#{</span><span class="Identifier">@name</span><span class="Special">}</span><span class="Constant">.ogm -A video.avi audio*.ogg</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>
<span class="PreProc">end</span>

opts = <span class="Type">GetoptLong</span>.new(
        [<span class="Special">'</span><span class="Constant">--help</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-h</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">OPTIONAL_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--name</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-n</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--dev</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-d</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--vcodec</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-v</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--acodec</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-a</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--bpp</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-b</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--fps</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-f</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--aquality</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-q</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--crop</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-c</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--extraopts</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-e</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--test</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-t</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">NO_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--input</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-i</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">NO_ARGUMENT</span>]
                     )

<span class="Comment"># Default values go here. The crop parameter will be detected if not specified</span>


encoder = <span class="Type">Encode</span>.new()

opts.each <span class="Statement">do</span> |<span class="Identifier">opt</span>, <span class="Identifier">arg</span>|
    <span class="Statement">case</span> opt
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--help</span><span class="Special">'</span>
        <span class="Statement">case</span> arg
        <span class="Statement">when</span> <span class="Special">''</span>
            <span class="Type">RDoc</span>::usage
        <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">u</span><span class="Special">'</span>
            <span class="Type">RDoc</span>::usage(<span class="Special">'</span><span class="Constant">Usage</span><span class="Special">'</span>)
        <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">a</span><span class="Special">'</span>
            <span class="Type">RDoc</span>::usage(<span class="Special">'</span><span class="Constant">Author</span><span class="Special">'</span>)
        <span class="Statement">when</span> <span class="Special">/</span><span class="Constant">l|c</span><span class="Special">/</span>
            <span class="Type">RDoc</span>::usage(<span class="Special">'</span><span class="Constant">Copyright</span><span class="Special">'</span>)
        <span class="Statement">end</span>
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--dev</span><span class="Special">'</span>
        encoder.dev = arg
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--bpp</span><span class="Special">'</span>
        encoder.bpp = arg.to_f
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--name</span><span class="Special">'</span>
        encoder.name = arg
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--acodec</span><span class="Special">'</span>
        encoder.acodec = arg
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--vcodec</span><span class="Special">'</span>
        encoder.vcodec = arg
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--crop</span><span class="Special">'</span>
        encoder.crop = arg
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--fps</span><span class="Special">'</span>
        encoder.fps = arg.to_f
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--extraopts</span><span class="Special">'</span>
        encoder.extraopts = arg
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--input</span><span class="Special">'</span>
        encoder.input = <span class="Constant">true</span>
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--test</span><span class="Special">'</span>
        encoder.run = <span class="Constant">false</span>
    <span class="Statement">end</span>
<span class="Statement">end</span>


<span class="Statement">if</span> encoder.crop == <span class="Constant">nil</span>
    encoder.get_info()
<span class="Statement">end</span>

<span class="Comment"># Rip the source to a temporary file if it is a dvd. This speeds up later</span>
<span class="Comment"># processing and removes the 'switching framerate' problems</span>
<span class="Statement">if</span> <span class="Special">/</span><span class="Constant">dvd</span><span class="Special">/</span> =~ encoder.dev
    encoder.load_vob()
<span class="Statement">end</span>

encoder.calc_vbitrate()

<span class="Comment"># Encode audio</span>
encoder.make_frameno()
encoder.aids.each <span class="Statement">do</span> |<span class="Identifier">aid</span>|
    encoder.make_ogg(aid)
<span class="Statement">end</span>

<span class="Statement">if</span> <span class="Special">'</span><span class="Constant">lavc</span><span class="Special">'</span> == encoder.vcodec
    encoder.make_lavc_2pass
<span class="Statement">elsif</span> <span class="Special">'</span><span class="Constant">xvid</span><span class="Special">'</span> == vcodec
    encoder.make_xvid_2pass
<span class="Statement">else</span>
    error(<span class="Special">&quot;</span><span class="Constant">Error: unknown video codec.</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

encoder.make_ogm

<span class="Comment"># Cleanup</span>
<span class="Comment">#if 'temp.vob' == dev</span>
<span class="Comment">#   puts(&quot;#{LIGHT_RED}rm -f temp.vob#{NO_COLOR}&quot;)</span>
<span class="Comment">#   execute(&quot;rm -f temp.vob&quot;)</span>
<span class="Comment">#end</span>
<span class="Comment">#puts(&quot;#{LIGHT_RED}rm -f video.avi audio.ogg divx2pass.log frameno.avi#{NO_COLOR}&quot;)</span>
<span class="Comment">#execute(&quot;rm -f video.avi audio.ogg divx2pass.log frameno.avi&quot;)</span>
</pre>
</body>
</html>
