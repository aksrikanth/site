<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Wireless Setup Script</title>
<meta name="Generator" content="Vim/7.1" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
<style type="text/css">
<!--
.Type { color: #0000ff; }
.Statement { color: #a52a2a; }
.Identifier { color: #0000ff; }
.Special { color: #ff00ff; }
.Constant { color: #ff00ff; }
pre { font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
.PreProc { color: #a020f0; }
.Comment { color: #ff0000; }
-->
</style>
</head>
<body>
<pre>
<span class="PreProc">#!/usr/bin/env ruby</span>

<span class="Comment"># == Synopsis</span>
<span class="Comment"># wireless : Start or stop the appropriate wireless network</span>
<span class="Comment">#</span>
<span class="Comment"># == Usage</span>
<span class="Comment">#</span>
<span class="Comment"># wireless [OPTION]</span>
<span class="Comment">#</span>
<span class="Comment"># -h, --help ::</span>
<span class="Comment">#   show this help message</span>
<span class="Comment"># -s, --start ::</span>
<span class="Comment">#   start the wireless network (default)</span>
<span class="Comment"># -p, --stop ::</span>
<span class="Comment">#   stop the current connection</span>
<span class="Comment"># -e, --essid ::</span>
<span class="Comment">#   the ESSID of the network to connect to</span>
<span class="Comment"># -k, --key ::</span>
<span class="Comment">#   the key for a secured network</span>
<span class="Comment">#</span>
<span class="Comment"># == Author</span>
<span class="Comment">#</span>
<span class="Comment"># Srikanth K Agaram, University of California, Irvine</span>
<span class="Comment">#</span>
<span class="Comment"># == Copyright</span>
<span class="Comment">#</span>
<span class="Comment"># Copyright (c) 2007 Srikanth Agaram. Licenced under the GNU GPLv3</span>

<span class="PreProc">require</span> <span class="Special">'</span><span class="Constant">getoptlong</span><span class="Special">'</span>
<span class="PreProc">require</span> <span class="Special">'</span><span class="Constant">rdoc/usage</span><span class="Special">'</span>

<span class="PreProc">class</span> <span class="Type">Wireless</span>
    <span class="Type">NO_COLOR</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[0m</span><span class="Special">&quot;</span>
    <span class="Type">GRAY</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;30m</span><span class="Special">&quot;</span>
    <span class="Type">LIGHT_RED</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;31m</span><span class="Special">&quot;</span>
    <span class="Type">GREEN</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[01;32m</span><span class="Special">&quot;</span>
    <span class="Type">YELLOW</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;33m</span><span class="Special">&quot;</span>
    <span class="Type">LIGHT_BLUE</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;34m</span><span class="Special">&quot;</span>
    <span class="Type">LIGHT_GRAY</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[0;37m</span><span class="Special">&quot;</span>
    <span class="Type">WHITE</span>=<span class="Special">&quot;</span><span class="Special">\033</span><span class="Constant">[1;37m</span><span class="Special">&quot;</span>

    <span class="Statement">attr_reader</span> <span class="Constant">:essid</span>, <span class="Constant">:key</span>, <span class="Constant">:mode</span>
    <span class="Statement">attr_writer</span> <span class="Constant">:essid</span>, <span class="Constant">:key</span>, <span class="Constant">:mode</span>

    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(essid, key)
        <span class="Identifier">@essid</span> = essid
        <span class="Identifier">@key</span> = key
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">inform</span>(message)
        puts <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">#{</span><span class="Type">GREEN</span><span class="Special">}#{</span>message<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">commandline</span>(command)
        puts <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">#{</span><span class="Type">YELLOW</span><span class="Special">}#{</span>command<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">question</span>(message)
        <span class="Statement">if</span> <span class="Identifier">@input</span>
            puts <span class="Special">&quot;</span><span class="Special">#{</span><span class="Type">LIGHT_BLUE</span><span class="Special">}#{</span>message<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>
            <span class="Statement">if</span> <span class="Special">&quot;&quot;</span> != gets.chomp.strip
                <span class="Statement">exit</span>(<span class="Constant">0</span>)
            <span class="Statement">end</span>
        <span class="Statement">end</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">warning</span>(message)
        puts <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">#{</span><span class="Type">LIGHT_RED</span><span class="Special">}</span><span class="Constant">Warning : </span><span class="Special">#{</span>message<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">error</span>(message)
        puts <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">#{</span><span class="Type">LIGHT_RED</span><span class="Special">}</span><span class="Constant">Error : </span><span class="Special">#{</span>message<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">fatal_error</span>(message, error_code)
        puts <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">#{</span><span class="Type">LIGHT_RED</span><span class="Special">}</span><span class="Constant">Fatal Error : </span><span class="Special">#{</span>message<span class="Special">}#{</span><span class="Type">NO_COLOR</span><span class="Special">}</span><span class="Special">&quot;</span>
        <span class="Statement">exit</span> error_code
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">start_daemon</span>
        <span class="Comment">#Start the ipw daemon if not running</span>
        inform <span class="Special">&quot;</span><span class="Constant">Checking for running ipw daemon</span><span class="Special">&quot;</span>
        <span class="Type">IO</span>.popen <span class="Special">&quot;</span><span class="Constant">ps -el | grep -c ipw3945d</span><span class="Special">&quot;</span> <span class="Statement">do</span> |<span class="Identifier">io</span>|
            num = io.gets.to_i
            <span class="Statement">if</span> num == <span class="Constant">0</span>
                inform <span class="Special">&quot;</span><span class="Special">\t</span><span class="Constant">ipw daemon not running. Starting ipw daemon...</span><span class="Special">&quot;</span>
                system <span class="Special">&quot;</span><span class="Constant">/sbin/modprobe ipw3945</span><span class="Special">&quot;</span>
                system <span class="Special">&quot;</span><span class="Constant">/etc/init.d/ipw3945d start</span><span class="Special">&quot;</span>
            <span class="Statement">else</span>
                inform <span class="Special">&quot;</span><span class="Special">\t</span><span class="Constant">ipw daemon running.</span><span class="Special">&quot;</span>
            <span class="Statement">end</span>
        <span class="Statement">end</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">get_network_list</span>
        foundlist = <span class="Type">Array</span>.new

        <span class="Comment"># Load the list of active wireless networks</span>
        inform <span class="Special">&quot;</span><span class="Constant">Finding active networks...</span><span class="Special">&quot;</span>
        <span class="Type">IO</span>.popen <span class="Special">&quot;</span><span class="Constant">iwlist </span><span class="Special">#{</span><span class="Type">Settings</span>[<span class="Special">'</span><span class="Constant">device</span><span class="Special">'</span>]<span class="Special">}</span><span class="Constant"> scanning</span><span class="Special">&quot;</span> <span class="Statement">do</span> |<span class="Identifier">io</span>|
            line = io.gets
            <span class="Statement">while</span> line != <span class="Constant">nil</span>
                <span class="Statement">if</span> <span class="Special">/</span><span class="Constant">.*ESSID.*</span><span class="Special">/</span> =~ line
                    foundlist.push(line.gsub(<span class="Special">/</span><span class="Constant">(.*:&quot;)|(&quot;$)</span><span class="Special">/</span>, <span class="Special">''</span>).chomp)
                <span class="Statement">end</span>
                line = io.gets
            <span class="Statement">end</span>
        <span class="Statement">end</span>
        <span class="Statement">if</span> foundlist.length == <span class="Constant">0</span>
            fatal_error(<span class="Special">&quot;</span><span class="Constant">No active networks found. Aborting!</span><span class="Special">&quot;</span>, <span class="Constant">1</span>)
        <span class="Statement">end</span>

        <span class="Statement">return</span> foundlist
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">load_settings</span>
        inform <span class="Special">&quot;</span><span class="Constant">Loading known networks...</span><span class="Special">&quot;</span>
        <span class="Comment"># Load the list of known wireless networks</span>
        <span class="PreProc">load</span> <span class="Special">'</span><span class="Constant">/etc/wireless.conf.rb</span><span class="Special">'</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">find_known_networks</span>(foundlist)
        done = <span class="Constant">false</span>
        foundlist.each <span class="Statement">do</span> |<span class="Identifier">found</span>|
            <span class="Statement">if</span> done != <span class="Constant">true</span>
                <span class="Type">KnownList</span>.each <span class="Statement">do</span> |<span class="Identifier">essid</span>, <span class="Identifier">key</span>|
                    <span class="Statement">if</span> found == essid
                        inform <span class="Special">&quot;</span><span class="Constant">Found known network '</span><span class="Special">#{</span>essid<span class="Special">}</span><span class="Constant">'</span><span class="Special">&quot;</span>
                        <span class="Identifier">@essid</span> = essid
                        <span class="Identifier">@key</span> = key
                        done = <span class="Constant">true</span>
                    <span class="Statement">end</span>
                <span class="Statement">end</span>
            <span class="Statement">end</span>
        <span class="Statement">end</span>

        <span class="Statement">if</span> done == <span class="Constant">false</span>
            warning <span class="Special">&quot;</span><span class="Constant">No known networks found.</span><span class="Special">&quot;</span>
            inform <span class="Special">&quot;</span><span class="Constant">Trying unknown network </span><span class="Special">#{</span>foundlist[<span class="Constant">0</span>]<span class="Special">}</span><span class="Constant">...</span><span class="Special">&quot;</span>
            <span class="Identifier">@essid</span> = foundlist[<span class="Constant">0</span>]
            <span class="Identifier">@key</span> = <span class="Constant">nil</span>
        <span class="Statement">end</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">up</span>
        system(<span class="Special">&quot;</span><span class="Constant">ifconfig </span><span class="Special">#{</span><span class="Type">Settings</span>[<span class="Special">'</span><span class="Constant">device</span><span class="Special">'</span>]<span class="Special">}</span><span class="Constant"> down</span><span class="Special">&quot;</span>)
        system(<span class="Special">&quot;</span><span class="Constant">iwconfig </span><span class="Special">#{</span><span class="Type">Settings</span>[<span class="Special">'</span><span class="Constant">device</span><span class="Special">'</span>]<span class="Special">}</span><span class="Constant"> essid \&quot;</span><span class="Special">#{</span><span class="Identifier">@essid</span><span class="Special">}</span><span class="Constant">\&quot;</span><span class="Special">&quot;</span>)
        <span class="Statement">if</span> <span class="Identifier">@key</span> != <span class="Constant">nil</span>
            system(<span class="Special">&quot;</span><span class="Constant">iwconfig </span><span class="Special">#{</span><span class="Type">Settings</span>[<span class="Special">'</span><span class="Constant">device</span><span class="Special">'</span>]<span class="Special">}</span><span class="Constant"> key \&quot;</span><span class="Special">#{</span><span class="Identifier">@key</span><span class="Special">}</span><span class="Constant">\&quot;</span><span class="Special">&quot;</span>)
        <span class="Statement">end</span>
        system(<span class="Special">&quot;</span><span class="Constant">dhclient -e </span><span class="Special">#{</span><span class="Type">Settings</span>[<span class="Special">'</span><span class="Constant">device</span><span class="Special">'</span>]<span class="Special">}</span><span class="Special">&quot;</span>)
        system(<span class="Special">&quot;</span><span class="Constant">cat /root/resolv.conf &gt;&gt; /etc/resolv.conf</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">down</span>
        commandline <span class="Special">&quot;</span><span class="Constant">ifconfig </span><span class="Special">#{</span><span class="Type">Settings</span>[<span class="Special">'</span><span class="Constant">device</span><span class="Special">'</span>]<span class="Special">}</span><span class="Constant"> down</span><span class="Special">&quot;</span>
        system(<span class="Special">&quot;</span><span class="Constant">ifconfig </span><span class="Special">#{</span><span class="Type">Settings</span>[<span class="Special">'</span><span class="Constant">device</span><span class="Special">'</span>]<span class="Special">}</span><span class="Constant"> down</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">start</span>
        load_settings
        start_daemon
        <span class="Statement">if</span> (<span class="Identifier">@essid</span> == <span class="Constant">nil</span>)
            list = get_network_list
            find_known_networks(list)
        <span class="Statement">end</span>
        up
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">stop</span>
        load_settings
        down
    <span class="PreProc">end</span>
<span class="PreProc">end</span>

opts = <span class="Type">GetoptLong</span>.new(
        [<span class="Special">'</span><span class="Constant">--help</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-h</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">OPTIONAL_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--start</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-s</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">NO_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--stop</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-p</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">NO_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--essid</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-e</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>],
        [<span class="Special">'</span><span class="Constant">--key</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">-k</span><span class="Special">'</span>, <span class="Type">GetoptLong</span>::<span class="Type">REQUIRED_ARGUMENT</span>]
                     )

essid = <span class="Constant">nil</span>
key = <span class="Constant">nil</span>
mode = <span class="Special">'</span><span class="Constant">start</span><span class="Special">'</span>

wireless = <span class="Type">Wireless</span>.new(essid, key)

opts.each <span class="Statement">do</span> |<span class="Identifier">opt</span>, <span class="Identifier">arg</span>|
    <span class="Statement">case</span> opt
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--help</span><span class="Special">'</span>
        <span class="Statement">case</span> arg
        <span class="Statement">when</span> <span class="Special">''</span>
            <span class="Type">RDoc</span>::usage
        <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">u</span><span class="Special">'</span>
            <span class="Type">RDoc</span>::usage(<span class="Special">'</span><span class="Constant">Usage</span><span class="Special">'</span>)
        <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">a</span><span class="Special">'</span>
            <span class="Type">RDoc</span>::usage(<span class="Special">'</span><span class="Constant">Author</span><span class="Special">'</span>)
        <span class="Statement">when</span> <span class="Special">/</span><span class="Constant">l|c</span><span class="Special">/</span>
            <span class="Type">RDoc</span>::usage(<span class="Special">'</span><span class="Constant">Copyright</span><span class="Special">'</span>)
        <span class="Statement">end</span>
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--start</span><span class="Special">'</span>
        mode = <span class="Special">'</span><span class="Constant">start</span><span class="Special">'</span>
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--stop</span><span class="Special">'</span>
        mode = <span class="Special">'</span><span class="Constant">stop</span><span class="Special">'</span>
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--essid</span><span class="Special">'</span>
        wireless.essid = arg
    <span class="Statement">when</span> <span class="Special">'</span><span class="Constant">--key</span><span class="Special">'</span>
        wireless.key = arg
    <span class="Statement">end</span>
<span class="Statement">end</span>

<span class="Statement">if</span> <span class="Special">/</span><span class="Constant">start</span><span class="Special">/</span> =~ mode
    wireless.start
<span class="Statement">elsif</span> <span class="Special">/</span><span class="Constant">stop</span><span class="Special">/</span> =~ mode
    wireless.stop
<span class="Statement">end</span>
</pre>
</body>
</html>
